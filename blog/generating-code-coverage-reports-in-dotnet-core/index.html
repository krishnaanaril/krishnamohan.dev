<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Scully 1.1.0">
  <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-118442837-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-118442837-2');
  </script>
  <meta charset="utf-8">
  <title>Generating Code Coverage Reports in Dotnet Core</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
  <link rel="manifest" href="manifest.json">  
  <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
  <meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="styles.ef62c810e847757e3b7f.css"><style></style><style>.cdk-high-contrast-active .mat-toolbar{outline:solid 1px}.mat-toolbar-row,.mat-toolbar-single-row{display:flex;box-sizing:border-box;padding:0 16px;width:100%;flex-direction:row;align-items:center;white-space:nowrap}.mat-toolbar-multiple-rows{display:flex;box-sizing:border-box;flex-direction:column;width:100%}
</style><script charset="utf-8" src="common-es2015.614a0cbcc8e0c572fd49.js"></script><script charset="utf-8" src="6-es2015.b424ac04737710d35ffd.js"></script><style>[_ngcontent-eyj-c26]::slotted(h1){color:#330625;background-color:#f8d3ec;padding:5px;border-radius:5px;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}.blog-post[_ngcontent-eyj-c26], .post-footer[_ngcontent-eyj-c26]{margin:auto;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;max-width:768px;font-size:18px;line-height:1.9;font-family:Raleway,sans-serif}@media (max-width:768px){.blog-post[_ngcontent-eyj-c26], .post-footer[_ngcontent-eyj-c26]{margin:0 10px}}pre[_ngcontent-eyj-c26]{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;background-color:rgba(0,0,0,.05);padding:20px}pre[_ngcontent-eyj-c26]   code[_ngcontent-eyj-c26]{background-color:transparent}code[_ngcontent-eyj-c26]{background-color:rgba(0,0,0,.05);padding:2px 4px;white-space:break-spaces;word-break:break-word}.blog-title[_ngcontent-eyj-c26]{font-weight:400;font-size:4.5rem;line-height:1;word-break:normal;display:block;margin:0 auto 10px;text-align:center;font-family:Zilla Slab,serif}@media (max-width:768px){.blog-title[_ngcontent-eyj-c26]{font-size:3rem}}hr[_ngcontent-eyj-c26]{width:100px}.sub-items-container[_ngcontent-eyj-c26], mat-chip-list[_ngcontent-eyj-c26]{display:flex;justify-content:center}mat-chip-list[_ngcontent-eyj-c26]{margin:50px auto 5px}.keywords[_ngcontent-eyj-c26]{background-color:#f5f5f5;padding:10px;border:1px solid grey}</style><meta name="title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="og:type" content="website"><meta name="og:url" content="/blog/generating-code-coverage-reports-in-dotnet-core"><meta name="og:title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="og:description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="og:image" content="/assets/banners/04.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="/blog/generating-code-coverage-reports-in-dotnet-core"><meta name="twitter:title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="twitter:description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="twitter:image" content="/assets/banners/04.png"><meta name="twitter:site" content="@krishnaanaril"><meta name="twitter:creator" content="@krishnaanaril"><meta name="keywords" content="dotnet"><style>.mat-chip{position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;transform:translateZ(0);border:none;-webkit-appearance:none;-moz-appearance:none}.mat-standard-chip{transition:box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1);display:inline-flex;padding:7px 12px;border-radius:16px;align-items:center;cursor:default;min-height:32px;height:1px}._mat-animation-noopable.mat-standard-chip{transition:none;animation:none}.mat-standard-chip .mat-chip-remove.mat-icon{width:18px;height:18px}.mat-standard-chip::after{top:0;left:0;right:0;bottom:0;position:absolute;border-radius:inherit;opacity:0;content:"";pointer-events:none;transition:opacity 200ms cubic-bezier(0.35, 0, 0.25, 1)}.mat-standard-chip:hover::after{opacity:.12}.mat-standard-chip:focus{outline:none}.mat-standard-chip:focus::after{opacity:.16}.cdk-high-contrast-active .mat-standard-chip{outline:solid 1px}.cdk-high-contrast-active .mat-standard-chip:focus{outline:dotted 2px}.mat-standard-chip.mat-chip-disabled::after{opacity:0}.mat-standard-chip.mat-chip-disabled .mat-chip-remove,.mat-standard-chip.mat-chip-disabled .mat-chip-trailing-icon{cursor:default}.mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar,.mat-standard-chip.mat-chip-with-avatar{padding-top:0;padding-bottom:0}.mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar{padding-right:8px;padding-left:0}[dir=rtl] .mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar{padding-left:8px;padding-right:0}.mat-standard-chip.mat-chip-with-trailing-icon{padding-top:7px;padding-bottom:7px;padding-right:8px;padding-left:12px}[dir=rtl] .mat-standard-chip.mat-chip-with-trailing-icon{padding-left:8px;padding-right:12px}.mat-standard-chip.mat-chip-with-avatar{padding-left:0;padding-right:12px}[dir=rtl] .mat-standard-chip.mat-chip-with-avatar{padding-right:0;padding-left:12px}.mat-standard-chip .mat-chip-avatar{width:24px;height:24px;margin-right:8px;margin-left:4px}[dir=rtl] .mat-standard-chip .mat-chip-avatar{margin-left:8px;margin-right:4px}.mat-standard-chip .mat-chip-remove,.mat-standard-chip .mat-chip-trailing-icon{width:18px;height:18px;cursor:pointer}.mat-standard-chip .mat-chip-remove,.mat-standard-chip .mat-chip-trailing-icon{margin-left:8px;margin-right:0}[dir=rtl] .mat-standard-chip .mat-chip-remove,[dir=rtl] .mat-standard-chip .mat-chip-trailing-icon{margin-right:8px;margin-left:0}.mat-chip-ripple{top:0;left:0;right:0;bottom:0;position:absolute;pointer-events:none;border-radius:inherit;overflow:hidden}.mat-chip-list-wrapper{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;margin:-4px}.mat-chip-list-wrapper input.mat-input-element,.mat-chip-list-wrapper .mat-standard-chip{margin:4px}.mat-chip-list-stacked .mat-chip-list-wrapper{flex-direction:column;align-items:flex-start}.mat-chip-list-stacked .mat-chip-list-wrapper .mat-standard-chip{width:100%}.mat-chip-avatar{border-radius:50%;justify-content:center;align-items:center;display:flex;overflow:hidden;object-fit:cover}input.mat-chip-input{width:150px;margin:4px;flex:1 0 150px}
</style><style>
      :host {
        display: none;
      }
      scully-content {
        display: none;
      }
    </style><script>window['ScullyIO']='generated';</script></head>

<body scully-version="1.1.0">
  <app-root _nghost-eyj-c13="" ng-version="11.2.2"><mat-toolbar _ngcontent-eyj-c13="" class="mat-toolbar tool-bar mat-toolbar-single-row"><nav _ngcontent-eyj-c13=""><ul _ngcontent-eyj-c13="" class="top-nav"><li _ngcontent-eyj-c13="" routerlink="/" routerlinkactive="nav-active" tabindex="0">Home</li><li _ngcontent-eyj-c13="">Blog</li><li _ngcontent-eyj-c13="">Projects</li><li _ngcontent-eyj-c13="">About</li></ul></nav></mat-toolbar><router-outlet _ngcontent-eyj-c13=""></router-outlet><app-blog _nghost-eyj-c26=""><div _ngcontent-eyj-c26="" class="blog-post">
    <div _ngcontent-eyj-c26="" class="title-section">
        <mat-chip-list _ngcontent-eyj-c26="" aria-label="Blog tags/keywords" class="mat-chip-list" id="mat-chip-list-0" tabindex="0" aria-required="false" aria-disabled="false" aria-invalid="false" aria-multiselectable="false" role="listbox" aria-orientation="horizontal"><div class="mat-chip-list-wrapper">
            <mat-chip _ngcontent-eyj-c26="" role="option" color="primary" class="mat-chip mat-focus-indicator keywords mat-primary mat-standard-chip" tabindex="-1" aria-disabled="false"><div class="mat-chip-ripple"></div>dotnet</mat-chip><!---->
        </div></mat-chip-list>
        <h1 _ngcontent-eyj-c26="" class="blog-title">Generating Code Coverage Reports in Dotnet Core</h1>
        <div _ngcontent-eyj-c26="" class="sub-items-container">
            <time _ngcontent-eyj-c26="">Jul 5, 2019</time>
        </div>
    </div>
    <hr _ngcontent-eyj-c26="">
    <!--scullyContent-begin--><p _ngcontent-eyj-c26="">Unlike other application frameworks <strong _ngcontent-eyj-c26="">.NET Core</strong> do not provide code coverage reports out of the box, even the code coverage <a href="https://github.com/microsoft/vstest/issues/981" _ngcontent-eyj-c26="">support </a>was provided only in dotnet core version 2.1. But the ‘<strong _ngcontent-eyj-c26="">Code Coverage Analysis</strong>’ is provided with Visual Studio Enterprise edition. You can find more information <a href="https://docs.microsoft.com/en-us/visualstudio/test/using-code-coverage-to-determine-how-much-code-is-being-tested?view=vs-2017" _ngcontent-eyj-c26="">here</a>.</p>
<p _ngcontent-eyj-c26="">That’s okay, we’ve other tools available to get the code coverage reports and here I’ll be briefly explaining about it. There is already a blog post about this <a href="https://gunnarpeipman.com/aspnet/code-coverage/" _ngcontent-eyj-c26="">topic</a> by <a href="https://twitter.com/gpeipman" _ngcontent-eyj-c26="">Gunnar Peipman</a>. You can refer that as well. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started.</p>
<h2 id="contents" _ngcontent-eyj-c26="">Contents</h2>
<ul _ngcontent-eyj-c26="">
<li _ngcontent-eyj-c26="">Prerequisites</li>
<li _ngcontent-eyj-c26="">Creating dotnet application and adding test project</li>
<li _ngcontent-eyj-c26="">Running tests with CLI</li>
<li _ngcontent-eyj-c26="">Convert *.coverage file to *.coveragexml file</li>
<li _ngcontent-eyj-c26="">Generate Reports using ReportGenerator</li>
<li _ngcontent-eyj-c26="">Powershell script with all the steps</li>
<li _ngcontent-eyj-c26="">Conclusion</li>
</ul>
<h2 id="prerequisites" _ngcontent-eyj-c26="">Prerequisites</h2>
<p _ngcontent-eyj-c26="">You need to install/Configure:</p>
<ul _ngcontent-eyj-c26="">
<li _ngcontent-eyj-c26="">Dotnet core version 2.1 or above.</li>
<li _ngcontent-eyj-c26="">Visual Studio 2017 or above / Visual studio code.</li>
<li _ngcontent-eyj-c26=""><a href="https://github.com/danielpalme" _ngcontent-eyj-c26="">Daniel Palme</a>’s <a href="https://danielpalme.github.io/ReportGenerator/usage.html" _ngcontent-eyj-c26="">ReportGenerator</a></li>
<li _ngcontent-eyj-c26=""><a href="https://www.nuget.org/packages/Microsoft.CodeCoverage/" _ngcontent-eyj-c26="">Microsoft.CodeCoverage</a></li>
</ul>
<h2 id="creating-dotnet-application-and-adding-test-project" _ngcontent-eyj-c26="">Creating dotnet application and adding test project</h2>
<p _ngcontent-eyj-c26="">You can make use of <em _ngcontent-eyj-c26="">dotnet new</em> command or Visual Studio templates for creating a new project and test project. Here I’ll be covering MSTest, you can try with another unit testing framework as well.</p>
<p _ngcontent-eyj-c26="">If you’ve a dotnet core application with version 1.x, you can do the following steps to get the code coverage.</p>
<p _ngcontent-eyj-c26="">• Upgraded test related nuget refernces to latest version</p>
<pre _ngcontent-eyj-c26=""><code class="language-xml" _ngcontent-eyj-c26="">&lt;PackageReference Include=”Microsoft.NET.Test.Sdk” Version=”15.9.0" /&gt;
&lt;PackageReference Include=”MSTest.TestAdapter” Version=”1.3.2" /&gt;
 &lt;PackageReference Include=”MSTest.TestFramework” Version=”1.3.2" /&gt;
</code></pre>
<p _ngcontent-eyj-c26="">• Add the following config in *.csproj files. More information is available <a href="https://github.com/Microsoft/vstest/issues/800" _ngcontent-eyj-c26="">here.</a></p>
<pre _ngcontent-eyj-c26=""><code class="language-xml" _ngcontent-eyj-c26="">&lt;DebugType&gt;Full&lt;/DebugType&gt;
</code></pre>
<h2 id="running-tests-with-cli" _ngcontent-eyj-c26="">Running tests with CLI</h2>
<p _ngcontent-eyj-c26="">Once we’ve created our application and added sufficient unit tests. We need to run these tests and get the code coverage info. You do so by running the following command.</p>
<pre _ngcontent-eyj-c26=""><code class="language-bash" _ngcontent-eyj-c26="">dotnet test &lt;Path to *.csproj file&gt; --results-directory:&lt;Test Result directory&gt; --collect:"Code Coverage"
</code></pre>
<p _ngcontent-eyj-c26="">But I had a problem, dotnet was analyzing my dependent libraries as well. I was using <a href="https://github.com/moq/moq" _ngcontent-eyj-c26="">Moq </a>for mocking and <a href="https://github.com/MisterJames/GenFu" _ngcontent-eyj-c26="">GenFu</a> to generate random test data. So I had to exclude these dlls during the code coverage analysis by creating a <a href="https://docs.microsoft.com/en-us/visualstudio/test/configure-unit-tests-by-using-a-dot-runsettings-file?view=vs-2019" _ngcontent-eyj-c26="">runsettings</a> file and add the following configuration:</p>
<pre _ngcontent-eyj-c26=""><code class="language-xml" _ngcontent-eyj-c26="">&lt;ModulePaths&gt;              
  &lt;Exclude&gt;                
    &lt;ModulePath&gt;.*Moq.dll&lt;/ModulePath&gt;
    &lt;ModulePath&gt;.*GenFu.dll&lt;/ModulePath&gt;                
  &lt;/Exclude&gt;
&lt;/ModulePaths&gt;
</code></pre>
<p _ngcontent-eyj-c26="">Include and exclude nodes use regular expressions. More information is available <a href="https://docs.microsoft.com/en-us/visualstudio/test/customizing-code-coverage-analysis?view=vs-2019#regular-expressions" _ngcontent-eyj-c26="">here</a>.</p>
<p _ngcontent-eyj-c26="">Now we need to run *test *command using this .runsettings file.</p>
<pre _ngcontent-eyj-c26=""><code class="language-bash" _ngcontent-eyj-c26="">dotnet test &lt;Path to .csproj file&gt; --settings:&lt;Path to .runsettings file&gt;
</code></pre>
<p _ngcontent-eyj-c26="">This will generate *.coverage file inside a folder whose name corresponds to a GUID. Right now dotnet core CLI <a href="https://github.com/microsoft/vstest/issues/1957#issue-420578504" _ngcontent-eyj-c26="">do not support</a> custom name for *.coverage file.</p>
<h2 id="convert-coverage-file-to-coveragexml-file" _ngcontent-eyj-c26="">Convert *.coverage file to *.coveragexml file</h2>
<p _ngcontent-eyj-c26="">*CodeCoverage.exe *is a tool that comes with the installation of Visual Studio. To generate a coverage report with ReportGenerator the file has to be converted to xml format.</p>
<p _ngcontent-eyj-c26="">To get the xml file you can use the following command:</p>
<pre _ngcontent-eyj-c26=""><code class="language-xml" _ngcontent-eyj-c26="">&lt;UserProfile&gt;\.nuget\packages\microsoft.codecoverage\&lt;version&gt;\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:&lt;xml file name with Path&gt;.coveragexml  &lt;path to coverage file&gt;

# Eg: C:\Users\krishnamohan\.nuget\packages\microsoft.codecoverage\15.9.0\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:d:\MyTestOutput.coveragexml  d:\SomeName.coverage
</code></pre>
<h2 id="generate-reports-using-reportgenerator" _ngcontent-eyj-c26="">Generate Reports using ReportGenerator</h2>
<p _ngcontent-eyj-c26="">We need to run another command using the installed ReportGenerator.dll.</p>
<pre _ngcontent-eyj-c26=""><code class="language-shell" _ngcontent-eyj-c26="">dotnet &lt;UserProfile&gt;\.nuget\packages\reportgenerator\&lt;version&gt;\tools\netcoreapp2.1\ReportGenerator.dll "-reports:&lt;Coveragexml file path&gt;" "-targetdir:&lt;path to coverage report&gt;"
&lt;#
Eg: dotnet C:\Users\krishnamohan\.nuget\packages\reportgenerator\4.1.10\tools\netcoreapp2.1\ReportGenerator.dll "-reports:d:\MyTestOutput.coveragexml" "-targetdir:d:\coveragereport"
#&gt;
</code></pre>
<p _ngcontent-eyj-c26="">This will generate reports in *.htm format in the given output folder. If you open the index.htm file you can view the report.</p>
<p _ngcontent-eyj-c26=""><img src="assets/images/03_01.png" alt="Sample Report Image" _ngcontent-eyj-c26=""><em _ngcontent-eyj-c26="">Sample Report Image. Source: <a href="https://github.com/danielpalme/ReportGenerator" _ngcontent-eyj-c26="">https://github.com/danielpalme/ReportGenerator</a></em></p>
<h2 id="powershell-script-with-all-the-steps" _ngcontent-eyj-c26="">Powershell script with all the steps</h2>
<pre _ngcontent-eyj-c26=""><code class="language-powershell" _ngcontent-eyj-c26="">param(
   [Parameter(Mandatory=$true)]
   [string]$testProjectPath,
   [Parameter(Mandatory=$true)]
   [string]$testSettingsPath,
   [Parameter(Mandatory=$true)]
   [string]$testResultsFolder
)

&lt;#
echo "Test Project Path" $testProjectPath
echo "Test Settings Path" $testSettingsPath
echo "Test Results Folder" $testResultsFolder
#&gt;

try {

   if (-not (Test-Path $testProjectPath)) 
   {
       throw [System.IO.FileNotFoundException] "$testProjectPath not found."
   }
   if (-not (Test-Path $testSettingsPath)) 
   {
       throw [System.IO.FileNotFoundException] "$testSettingsPath not found."
   }
   if (-not (Test-Path $testResultsFolder)) 
   {
       throw [System.IO.FileNotFoundException] "$testResultsFolder not found."
   }

   dotnet test $testProjectPath --settings:$testSettingsPath 
   $recentCoverageFile = Get-ChildItem -File -Filter *.coverage -Path $testResultsFolder -Name -Recurse | Select-Object -First 1;
   write-host 'Test Completed'  -ForegroundColor Green

   C:\Users\krishnamohan\.nuget\packages\microsoft.codecoverage\15.9.0\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:$testResultsFolder\MyTestOutput.coveragexml  $testResultsFolder'\'$recentCoverageFile
   write-host 'CoverageXML Generated'  -ForegroundColor Green

   dotnet C:\Users\krishnamohan\.nuget\packages\reportgenerator\4.1.10\tools\netcoreapp2.1\ReportGenerator.dll "-reports:$testResultsFolder\MyTestOutput.coveragexml" "-targetdir:$testResultsFolder\coveragereport"
   write-host 'CoverageReport Published'  -ForegroundColor Green

}
catch {

   write-host "Caught an exception:" -ForegroundColor Red
   write-host "Exception Type: $($_.Exception.GetType().FullName)" -ForegroundColor Red
   write-host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red

}
</code></pre>
<h2 id="conclusion" _ngcontent-eyj-c26="">Conclusion</h2>
<p _ngcontent-eyj-c26="">It took some time for me to figure it out as lot of information regarding this was scattered all over the internet. Finally it was worth the effort and coverage reports really improve quality of unit tests and helps developer to write better unit tests. Hope this blog post will be helpful for dotnet developers treading the same path.</p>
<!--scullyContent-end--><scully-content _ngcontent-eyj-c26=""></scully-content>
    <hr _ngcontent-eyj-c26="">
    <div _ngcontent-eyj-c26="" class="post-footer">
        Have questions/comments? Tweet @<a _ngcontent-eyj-c26="" href="https://twitter.com/krishnaanaril">krishnaanaril</a>
    </div>
<script>try {window['scullyContent'] = {cssId:"_ngcontent-eyj-c26",html:document.body.innerHTML.split('<!--scullyContent-begin-->')[1].split('<!--scullyContent-end-->')[0]};} catch(e) {console.error('scully could not parse content');}</script></div><!----></app-blog><!----></app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
<script id="ScullyIO-transfer-state"></script><script src="runtime-es2015.c522a9070bf33bce67b5.js" type="module"></script><script src="runtime-es5.c522a9070bf33bce67b5.js" nomodule="" defer=""></script><script src="polyfills-es5.29147128fc6f0f3fd286.js" nomodule="" defer=""></script><script src="polyfills-es2015.2045db6d95f407e1e8c7.js" type="module"></script><script src="main-es2015.caa4d0242215b095a5dc.js" type="module"></script><script src="main-es5.caa4d0242215b095a5dc.js" nomodule="" defer=""></script>

</body></html>