<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Scully 1.1.0">
  <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-118442837-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-118442837-2');
  </script>
  <meta charset="utf-8">
  <title>Generating Code Coverage Reports in Dotnet Core</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
  <link rel="manifest" href="manifest.json">  
  <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
  <meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="styles.a2b28656b110b767de07.css"><style></style><script charset="utf-8" src="common-es2015.e42dcdd43780d81208f1.js"></script><script charset="utf-8" src="6-es2015.d141599c7f049700f633.js"></script><style>ol[_ngcontent-rol-c9]{list-style-type:decimal}ul[_ngcontent-rol-c9]{list-style-type:disc;padding-left:2.5rem}p[_ngcontent-rol-c9]{padding-top:1.25rem;padding-bottom:1.25rem}h2[_ngcontent-rol-c9]{font-size:1.875rem;line-height:2.25rem;margin-top:1.25rem;margin-bottom:1.25rem}h3[_ngcontent-rol-c9]{font-size:1.5rem;line-height:2rem;margin-top:.75rem;margin-bottom:.75rem}pre[_ngcontent-rol-c9]{font-size:1rem;line-height:1.5rem;margin-bottom:1.25rem;padding:1.25rem}a[_ngcontent-rol-c9]{--tw-border-opacity:1;border-color:rgba(37,99,235,var(--tw-border-opacity));border-bottom-width:2px}</style><meta name="title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="og:type" content="article"><meta name="og:url" content="/blog/generating-code-coverage-reports-in-dotnet-core"><meta name="og:title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="og:description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="og:image" content="assets/banners/04"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="/blog/generating-code-coverage-reports-in-dotnet-core"><meta name="twitter:title" content="Generating Code Coverage Reports in Dotnet Core"><meta name="twitter:description" content="Unlike other application frameworks .NET Core do not provide code coverage reports out of the box. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started."><meta name="twitter:image" content="assets/banners/04"><meta name="twitter:site" content="@krishnaanaril"><meta name="twitter:creator" content="@krishnaanaril"><meta name="keywords" content="dotnet"><meta name="og:article:published_time" content="2019-07-05T00:00:00.000Z"><meta name="og:article:modified_time" content="2019-07-05T00:00:00.000Z"><meta name="og:article:author" content="Krishna Mohan A M"><meta name="og:article:section" content="Tech"><meta name="og:article:tag" content="dotnet"><style>
      :host {
        display: none;
      }
      scully-content {
        display: none;
      }
    </style><script>window['ScullyIO']='generated';</script></head>

<body scully-version="1.1.0">
  <app-root _nghost-rol-c7="" ng-version="11.2.2"><div _ngcontent-rol-c7="" class="bg-gray-200 text-gray-800 dark:bg-black dark:text-gray-50"><div _ngcontent-rol-c7="" class="container mx-auto bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><section _ngcontent-rol-c7="" class="hidden lg:flex flex-row justify-center"><nav _ngcontent-rol-c7=""><ul _ngcontent-rol-c7="" class="lg:text-xl lg:flex lg:flex-row"><li _ngcontent-rol-c7="" routerlinkactive="border-b-2 border-gray-700 dark:border-gray-300" class="p-3 cursor-pointer" tabindex="0">Home</li><li _ngcontent-rol-c7="" routerlinkactive="border-b-2 border-gray-700 dark:border-gray-300" class="p-3 cursor-pointer border-b-2 border-gray-700 dark:border-gray-300" tabindex="0">Blog</li><li _ngcontent-rol-c7="" routerlinkactive="border-b-2 border-gray-700 dark:border-gray-300" class="p-3 cursor-pointer" tabindex="0">Projects</li><li _ngcontent-rol-c7="" routerlinkactive="border-b-2 border-gray-700 dark:border-gray-300" class="p-3 cursor-pointer" tabindex="0">About</li><!----></ul></nav></section><div _ngcontent-rol-c7="" class="absolute lg:hidden mr-4 p-4 right-0"><button _ngcontent-rol-c7="" aria-label="view menu items" class="p-2"><svg _ngcontent-rol-c7="" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="24px" height="24px" class="fill-current"><path _ngcontent-rol-c7="" d="M0 0h24v24H0z" fill="none"></path><path _ngcontent-rol-c7="" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></div><!----><router-outlet _ngcontent-rol-c7=""></router-outlet><app-blog-post _nghost-rol-c9=""><div _ngcontent-rol-c9="" class="container mx-auto min-h-screen bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50">
    <div _ngcontent-rol-c9="">
        <div _ngcontent-rol-c9="" aria-label="Blog tags/keywords" class="pt-8 flex flex-row justify-center">
            <div _ngcontent-rol-c9="" class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full">dotnet</div><!---->
        </div>
        <div _ngcontent-rol-c9="" class="max-w-screen-lg mx-auto">
            <h1 _ngcontent-rol-c9="" class="text-5xl pt-5 pb-5 text-center">Generating Code Coverage Reports in Dotnet Core</h1>
        </div>
        <div _ngcontent-rol-c9="" class="flex flex-row justify-center m-5 max-w-screen-sm mx-auto">
            <time _ngcontent-rol-c9="" class="text-center text-xl">Jul 5, 2019</time>
        </div>
    </div>
    <hr _ngcontent-rol-c9="" class="mx-auto border-gray-800 w-1/4">
    <div _ngcontent-rol-c9="" class="max-w-screen-md mx-auto p-6 md:p-12 leading-8">
        <!--scullyContent-begin--><p _ngcontent-rol-c9="">Unlike other application frameworks <strong _ngcontent-rol-c9="">.NET Core</strong> do not provide code coverage reports out of the box, even the code coverage <a href="https://github.com/microsoft/vstest/issues/981" _ngcontent-rol-c9="">support </a>was provided only in dotnet core version 2.1. But the ‘<strong _ngcontent-rol-c9="">Code Coverage Analysis</strong>’ is provided with Visual Studio Enterprise edition. You can find more information <a href="https://docs.microsoft.com/en-us/visualstudio/test/using-code-coverage-to-determine-how-much-code-is-being-tested?view=vs-2017" _ngcontent-rol-c9="">here</a>.</p>
<p _ngcontent-rol-c9="">That’s okay, we’ve other tools available to get the code coverage reports and here I’ll be briefly explaining about it. There is already a blog post about this <a href="https://gunnarpeipman.com/aspnet/code-coverage/" _ngcontent-rol-c9="">topic</a> by <a href="https://twitter.com/gpeipman" _ngcontent-rol-c9="">Gunnar Peipman</a>. You can refer that as well. Here I’ll be using a different approach which actually suited my web application. Without further ado, let’s get started.</p>
<h2 id="contents" _ngcontent-rol-c9="">Contents</h2>
<ul _ngcontent-rol-c9="">
<li _ngcontent-rol-c9="">Prerequisites</li>
<li _ngcontent-rol-c9="">Creating dotnet application and adding test project</li>
<li _ngcontent-rol-c9="">Running tests with CLI</li>
<li _ngcontent-rol-c9="">Convert *.coverage file to *.coveragexml file</li>
<li _ngcontent-rol-c9="">Generate Reports using ReportGenerator</li>
<li _ngcontent-rol-c9="">Powershell script with all the steps</li>
<li _ngcontent-rol-c9="">Conclusion</li>
</ul>
<h2 id="prerequisites" _ngcontent-rol-c9="">Prerequisites</h2>
<p _ngcontent-rol-c9="">You need to install/Configure:</p>
<ul _ngcontent-rol-c9="">
<li _ngcontent-rol-c9="">Dotnet core version 2.1 or above.</li>
<li _ngcontent-rol-c9="">Visual Studio 2017 or above / Visual studio code.</li>
<li _ngcontent-rol-c9=""><a href="https://github.com/danielpalme" _ngcontent-rol-c9="">Daniel Palme</a>’s <a href="https://danielpalme.github.io/ReportGenerator/usage.html" _ngcontent-rol-c9="">ReportGenerator</a></li>
<li _ngcontent-rol-c9=""><a href="https://www.nuget.org/packages/Microsoft.CodeCoverage/" _ngcontent-rol-c9="">Microsoft.CodeCoverage</a></li>
</ul>
<h2 id="creating-dotnet-application-and-adding-test-project" _ngcontent-rol-c9="">Creating dotnet application and adding test project</h2>
<p _ngcontent-rol-c9="">You can make use of <em _ngcontent-rol-c9="">dotnet new</em> command or Visual Studio templates for creating a new project and test project. Here I’ll be covering MSTest, you can try with another unit testing framework as well.</p>
<p _ngcontent-rol-c9="">If you’ve a dotnet core application with version 1.x, you can do the following steps to get the code coverage.</p>
<p _ngcontent-rol-c9="">• Upgraded test related nuget refernces to latest version</p>
<pre _ngcontent-rol-c9=""><code class="language-xml" _ngcontent-rol-c9="">&lt;PackageReference Include=”Microsoft.NET.Test.Sdk” Version=”15.9.0" /&gt;
&lt;PackageReference Include=”MSTest.TestAdapter” Version=”1.3.2" /&gt;
 &lt;PackageReference Include=”MSTest.TestFramework” Version=”1.3.2" /&gt;
</code></pre>
<p _ngcontent-rol-c9="">• Add the following config in *.csproj files. More information is available <a href="https://github.com/Microsoft/vstest/issues/800" _ngcontent-rol-c9="">here.</a></p>
<pre _ngcontent-rol-c9=""><code class="language-xml" _ngcontent-rol-c9="">&lt;DebugType&gt;Full&lt;/DebugType&gt;
</code></pre>
<h2 id="running-tests-with-cli" _ngcontent-rol-c9="">Running tests with CLI</h2>
<p _ngcontent-rol-c9="">Once we’ve created our application and added sufficient unit tests. We need to run these tests and get the code coverage info. You do so by running the following command.</p>
<pre _ngcontent-rol-c9=""><code class="language-bash" _ngcontent-rol-c9="">dotnet test &lt;Path to *.csproj file&gt; --results-directory:&lt;Test Result directory&gt; --collect:"Code Coverage"
</code></pre>
<p _ngcontent-rol-c9="">But I had a problem, dotnet was analyzing my dependent libraries as well. I was using <a href="https://github.com/moq/moq" _ngcontent-rol-c9="">Moq </a>for mocking and <a href="https://github.com/MisterJames/GenFu" _ngcontent-rol-c9="">GenFu</a> to generate random test data. So I had to exclude these dlls during the code coverage analysis by creating a <a href="https://docs.microsoft.com/en-us/visualstudio/test/configure-unit-tests-by-using-a-dot-runsettings-file?view=vs-2019" _ngcontent-rol-c9="">runsettings</a> file and add the following configuration:</p>
<pre _ngcontent-rol-c9=""><code class="language-xml" _ngcontent-rol-c9="">&lt;ModulePaths&gt;              
  &lt;Exclude&gt;                
    &lt;ModulePath&gt;.*Moq.dll&lt;/ModulePath&gt;
    &lt;ModulePath&gt;.*GenFu.dll&lt;/ModulePath&gt;                
  &lt;/Exclude&gt;
&lt;/ModulePaths&gt;
</code></pre>
<p _ngcontent-rol-c9="">Include and exclude nodes use regular expressions. More information is available <a href="https://docs.microsoft.com/en-us/visualstudio/test/customizing-code-coverage-analysis?view=vs-2019#regular-expressions" _ngcontent-rol-c9="">here</a>.</p>
<p _ngcontent-rol-c9="">Now we need to run *test *command using this .runsettings file.</p>
<pre _ngcontent-rol-c9=""><code class="language-bash" _ngcontent-rol-c9="">dotnet test &lt;Path to .csproj file&gt; --settings:&lt;Path to .runsettings file&gt;
</code></pre>
<p _ngcontent-rol-c9="">This will generate *.coverage file inside a folder whose name corresponds to a GUID. Right now dotnet core CLI <a href="https://github.com/microsoft/vstest/issues/1957#issue-420578504" _ngcontent-rol-c9="">do not support</a> custom name for *.coverage file.</p>
<h2 id="convert-coverage-file-to-coveragexml-file" _ngcontent-rol-c9="">Convert *.coverage file to *.coveragexml file</h2>
<p _ngcontent-rol-c9="">*CodeCoverage.exe *is a tool that comes with the installation of Visual Studio. To generate a coverage report with ReportGenerator the file has to be converted to xml format.</p>
<p _ngcontent-rol-c9="">To get the xml file you can use the following command:</p>
<pre _ngcontent-rol-c9=""><code class="language-xml" _ngcontent-rol-c9="">&lt;UserProfile&gt;\.nuget\packages\microsoft.codecoverage\&lt;version&gt;\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:&lt;xml file name with Path&gt;.coveragexml  &lt;path to coverage file&gt;

# Eg: C:\Users\krishnamohan\.nuget\packages\microsoft.codecoverage\15.9.0\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:d:\MyTestOutput.coveragexml  d:\SomeName.coverage
</code></pre>
<h2 id="generate-reports-using-reportgenerator" _ngcontent-rol-c9="">Generate Reports using ReportGenerator</h2>
<p _ngcontent-rol-c9="">We need to run another command using the installed ReportGenerator.dll.</p>
<pre _ngcontent-rol-c9=""><code class="language-shell" _ngcontent-rol-c9="">dotnet &lt;UserProfile&gt;\.nuget\packages\reportgenerator\&lt;version&gt;\tools\netcoreapp2.1\ReportGenerator.dll "-reports:&lt;Coveragexml file path&gt;" "-targetdir:&lt;path to coverage report&gt;"
&lt;#
Eg: dotnet C:\Users\krishnamohan\.nuget\packages\reportgenerator\4.1.10\tools\netcoreapp2.1\ReportGenerator.dll "-reports:d:\MyTestOutput.coveragexml" "-targetdir:d:\coveragereport"
#&gt;
</code></pre>
<p _ngcontent-rol-c9="">This will generate reports in *.htm format in the given output folder. If you open the index.htm file you can view the report.</p>
<p _ngcontent-rol-c9=""><img src="assets/images/03_01.png" alt="Sample Report Image" _ngcontent-rol-c9=""><em _ngcontent-rol-c9="">Sample Report Image. Source: <a href="https://github.com/danielpalme/ReportGenerator" _ngcontent-rol-c9="">https://github.com/danielpalme/ReportGenerator</a></em></p>
<h2 id="powershell-script-with-all-the-steps" _ngcontent-rol-c9="">Powershell script with all the steps</h2>
<pre _ngcontent-rol-c9=""><code class="language-powershell" _ngcontent-rol-c9="">param(
   [Parameter(Mandatory=$true)]
   [string]$testProjectPath,
   [Parameter(Mandatory=$true)]
   [string]$testSettingsPath,
   [Parameter(Mandatory=$true)]
   [string]$testResultsFolder
)

&lt;#
echo "Test Project Path" $testProjectPath
echo "Test Settings Path" $testSettingsPath
echo "Test Results Folder" $testResultsFolder
#&gt;

try {

   if (-not (Test-Path $testProjectPath)) 
   {
       throw [System.IO.FileNotFoundException] "$testProjectPath not found."
   }
   if (-not (Test-Path $testSettingsPath)) 
   {
       throw [System.IO.FileNotFoundException] "$testSettingsPath not found."
   }
   if (-not (Test-Path $testResultsFolder)) 
   {
       throw [System.IO.FileNotFoundException] "$testResultsFolder not found."
   }

   dotnet test $testProjectPath --settings:$testSettingsPath 
   $recentCoverageFile = Get-ChildItem -File -Filter *.coverage -Path $testResultsFolder -Name -Recurse | Select-Object -First 1;
   write-host 'Test Completed'  -ForegroundColor Green

   C:\Users\krishnamohan\.nuget\packages\microsoft.codecoverage\15.9.0\build\netstandard1.0\CodeCoverage\CodeCoverage.exe analyze  /output:$testResultsFolder\MyTestOutput.coveragexml  $testResultsFolder'\'$recentCoverageFile
   write-host 'CoverageXML Generated'  -ForegroundColor Green

   dotnet C:\Users\krishnamohan\.nuget\packages\reportgenerator\4.1.10\tools\netcoreapp2.1\ReportGenerator.dll "-reports:$testResultsFolder\MyTestOutput.coveragexml" "-targetdir:$testResultsFolder\coveragereport"
   write-host 'CoverageReport Published'  -ForegroundColor Green

}
catch {

   write-host "Caught an exception:" -ForegroundColor Red
   write-host "Exception Type: $($_.Exception.GetType().FullName)" -ForegroundColor Red
   write-host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red

}
</code></pre>
<h2 id="conclusion" _ngcontent-rol-c9="">Conclusion</h2>
<p _ngcontent-rol-c9="">It took some time for me to figure it out as lot of information regarding this was scattered all over the internet. Finally it was worth the effort and coverage reports really improve quality of unit tests and helps developer to write better unit tests. Hope this blog post will be helpful for dotnet developers treading the same path.</p>
<!--scullyContent-end--><scully-content _ngcontent-rol-c9=""></scully-content>
    <script>try {window['scullyContent'] = {cssId:"_ngcontent-rol-c9",html:document.body.innerHTML.split('<!--scullyContent-begin-->')[1].split('<!--scullyContent-end-->')[0]};} catch(e) {console.error('scully could not parse content');}</script></div>
    <hr _ngcontent-rol-c9="" class="border-gray-800">    
</div><!----></app-blog-post><!----><footer _ngcontent-rol-c7="" class="container mx-auto flex flex-col bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div _ngcontent-rol-c7="" class="mt-10"><ul _ngcontent-rol-c7="" class="flex flex-row justify-between max-w-sm mx-auto pl-4 pr-4"><li _ngcontent-rol-c7="" class="hover:text-gray-600 dark:hover:text-gray-100"><a _ngcontent-rol-c7="" href="https://twitter.com/KrishnaAnaril">Twitter</a></li><li _ngcontent-rol-c7=""><a _ngcontent-rol-c7="" href="https://krishnamohan.dev/sitemap-blog.xml">Sitemap</a></li><li _ngcontent-rol-c7=""><a _ngcontent-rol-c7="" href="https://krishnamohan.dev/feed.xml">RSS</a></li><li _ngcontent-rol-c7=""><a _ngcontent-rol-c7="" href="mailto:krishnamohan.a.m@gmail.com">Contact</a></li></ul></div><div _ngcontent-rol-c7="" class="mx-auto p-5 text-sm"><p _ngcontent-rol-c7="">© 2021-present <a _ngcontent-rol-c7="" href="https://krishnamohan.dev/" class="font-bold">Krishna Mohan A M</a>. All Rights Reserved.</p></div></footer></div></app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
<script id="ScullyIO-transfer-state"></script><script src="runtime-es2015.0c258286a84a90756f17.js" type="module"></script><script src="runtime-es5.0c258286a84a90756f17.js" nomodule="" defer=""></script><script src="polyfills-es5.29147128fc6f0f3fd286.js" nomodule="" defer=""></script><script src="polyfills-es2015.2045db6d95f407e1e8c7.js" type="module"></script><script src="main-es2015.eab9977039ea66e72c73.js" type="module"></script><script src="main-es5.eab9977039ea66e72c73.js" nomodule="" defer=""></script>

</body></html>