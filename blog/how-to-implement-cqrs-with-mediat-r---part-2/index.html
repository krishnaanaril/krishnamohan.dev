<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Scully 1.1.0">
  <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-118442837-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-118442837-2');
  </script>
  <meta charset="utf-8">
  <title>How to implement CQRS with MediatR - Part 2</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
  <link rel="manifest" href="manifest.json">  
  <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
  <meta name="theme-color" content="#1976d2">
<link rel="stylesheet" href="styles.ef62c810e847757e3b7f.css"><style></style><style>.cdk-high-contrast-active .mat-toolbar{outline:solid 1px}.mat-toolbar-row,.mat-toolbar-single-row{display:flex;box-sizing:border-box;padding:0 16px;width:100%;flex-direction:row;align-items:center;white-space:nowrap}.mat-toolbar-multiple-rows{display:flex;box-sizing:border-box;flex-direction:column;width:100%}
</style><script charset="utf-8" src="common-es2015.614a0cbcc8e0c572fd49.js"></script><script charset="utf-8" src="6-es2015.b424ac04737710d35ffd.js"></script><style>[_ngcontent-sxe-c26]::slotted(h1){color:#330625;background-color:#f8d3ec;padding:5px;border-radius:5px;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}.blog-post[_ngcontent-sxe-c26], .post-footer[_ngcontent-sxe-c26]{margin:auto;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;max-width:768px;font-size:18px;line-height:1.9;font-family:Raleway,sans-serif}@media (max-width:768px){.blog-post[_ngcontent-sxe-c26], .post-footer[_ngcontent-sxe-c26]{margin:0 10px}}pre[_ngcontent-sxe-c26]{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;background-color:rgba(0,0,0,.05);padding:20px}pre[_ngcontent-sxe-c26]   code[_ngcontent-sxe-c26]{background-color:transparent}code[_ngcontent-sxe-c26]{background-color:rgba(0,0,0,.05);padding:2px 4px;white-space:break-spaces;word-break:break-word}.blog-title[_ngcontent-sxe-c26]{font-weight:400;font-size:4.5rem;line-height:1;word-break:normal;display:block;margin:0 auto 10px;text-align:center;font-family:Zilla Slab,serif}@media (max-width:768px){.blog-title[_ngcontent-sxe-c26]{font-size:3rem}}hr[_ngcontent-sxe-c26]{width:100px}.sub-items-container[_ngcontent-sxe-c26], mat-chip-list[_ngcontent-sxe-c26]{display:flex;justify-content:center}mat-chip-list[_ngcontent-sxe-c26]{margin:50px auto 5px}.keywords[_ngcontent-sxe-c26]{background-color:#f5f5f5;padding:10px;border:1px solid grey}</style><meta name="title" content="How to implement CQRS with MediatR - Part 2"><meta name="description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."><meta name="og:type" content="website"><meta name="og:url" content="/blog/how-to-implement-cqrs-with-mediat-r---part-2"><meta name="og:title" content="How to implement CQRS with MediatR - Part 2"><meta name="og:description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."><meta name="og:image" content="https://krishnamohan.dev/assets/banners/17.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="/blog/how-to-implement-cqrs-with-mediat-r---part-2"><meta name="twitter:title" content="How to implement CQRS with MediatR - Part 2"><meta name="twitter:description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."><meta name="twitter:image" content="https://krishnamohan.dev/assets/banners/17.png"><meta name="twitter:site" content="@krishnaanaril"><meta name="twitter:creator" content="@krishnaanaril"><meta name="keywords" content="dotnet, mediatr, CancellationToken"><style>.mat-chip{position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;transform:translateZ(0);border:none;-webkit-appearance:none;-moz-appearance:none}.mat-standard-chip{transition:box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1);display:inline-flex;padding:7px 12px;border-radius:16px;align-items:center;cursor:default;min-height:32px;height:1px}._mat-animation-noopable.mat-standard-chip{transition:none;animation:none}.mat-standard-chip .mat-chip-remove.mat-icon{width:18px;height:18px}.mat-standard-chip::after{top:0;left:0;right:0;bottom:0;position:absolute;border-radius:inherit;opacity:0;content:"";pointer-events:none;transition:opacity 200ms cubic-bezier(0.35, 0, 0.25, 1)}.mat-standard-chip:hover::after{opacity:.12}.mat-standard-chip:focus{outline:none}.mat-standard-chip:focus::after{opacity:.16}.cdk-high-contrast-active .mat-standard-chip{outline:solid 1px}.cdk-high-contrast-active .mat-standard-chip:focus{outline:dotted 2px}.mat-standard-chip.mat-chip-disabled::after{opacity:0}.mat-standard-chip.mat-chip-disabled .mat-chip-remove,.mat-standard-chip.mat-chip-disabled .mat-chip-trailing-icon{cursor:default}.mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar,.mat-standard-chip.mat-chip-with-avatar{padding-top:0;padding-bottom:0}.mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar{padding-right:8px;padding-left:0}[dir=rtl] .mat-standard-chip.mat-chip-with-trailing-icon.mat-chip-with-avatar{padding-left:8px;padding-right:0}.mat-standard-chip.mat-chip-with-trailing-icon{padding-top:7px;padding-bottom:7px;padding-right:8px;padding-left:12px}[dir=rtl] .mat-standard-chip.mat-chip-with-trailing-icon{padding-left:8px;padding-right:12px}.mat-standard-chip.mat-chip-with-avatar{padding-left:0;padding-right:12px}[dir=rtl] .mat-standard-chip.mat-chip-with-avatar{padding-right:0;padding-left:12px}.mat-standard-chip .mat-chip-avatar{width:24px;height:24px;margin-right:8px;margin-left:4px}[dir=rtl] .mat-standard-chip .mat-chip-avatar{margin-left:8px;margin-right:4px}.mat-standard-chip .mat-chip-remove,.mat-standard-chip .mat-chip-trailing-icon{width:18px;height:18px;cursor:pointer}.mat-standard-chip .mat-chip-remove,.mat-standard-chip .mat-chip-trailing-icon{margin-left:8px;margin-right:0}[dir=rtl] .mat-standard-chip .mat-chip-remove,[dir=rtl] .mat-standard-chip .mat-chip-trailing-icon{margin-right:8px;margin-left:0}.mat-chip-ripple{top:0;left:0;right:0;bottom:0;position:absolute;pointer-events:none;border-radius:inherit;overflow:hidden}.mat-chip-list-wrapper{display:flex;flex-direction:row;flex-wrap:wrap;align-items:center;margin:-4px}.mat-chip-list-wrapper input.mat-input-element,.mat-chip-list-wrapper .mat-standard-chip{margin:4px}.mat-chip-list-stacked .mat-chip-list-wrapper{flex-direction:column;align-items:flex-start}.mat-chip-list-stacked .mat-chip-list-wrapper .mat-standard-chip{width:100%}.mat-chip-avatar{border-radius:50%;justify-content:center;align-items:center;display:flex;overflow:hidden;object-fit:cover}input.mat-chip-input{width:150px;margin:4px;flex:1 0 150px}
</style><style>
      :host {
        display: none;
      }
      scully-content {
        display: none;
      }
    </style><script>window['ScullyIO']='generated';</script></head>

<body scully-version="1.1.0">
  <app-root _nghost-sxe-c13="" ng-version="11.2.2"><mat-toolbar _ngcontent-sxe-c13="" class="mat-toolbar tool-bar mat-toolbar-single-row"><nav _ngcontent-sxe-c13=""><ul _ngcontent-sxe-c13="" class="top-nav"><li _ngcontent-sxe-c13="" routerlink="/" routerlinkactive="nav-active" tabindex="0">Home</li><li _ngcontent-sxe-c13="">Blog</li><li _ngcontent-sxe-c13="">Projects</li><li _ngcontent-sxe-c13="">About</li></ul></nav></mat-toolbar><router-outlet _ngcontent-sxe-c13=""></router-outlet><app-blog _nghost-sxe-c26=""><div _ngcontent-sxe-c26="" class="blog-post">
    <div _ngcontent-sxe-c26="" class="title-section">
        <mat-chip-list _ngcontent-sxe-c26="" aria-label="Blog tags/keywords" class="mat-chip-list" id="mat-chip-list-0" tabindex="0" aria-required="false" aria-disabled="false" aria-invalid="false" aria-multiselectable="false" role="listbox" aria-orientation="horizontal"><div class="mat-chip-list-wrapper">
            <mat-chip _ngcontent-sxe-c26="" role="option" color="primary" class="mat-chip mat-focus-indicator keywords mat-primary mat-standard-chip" tabindex="-1" aria-disabled="false"><div class="mat-chip-ripple"></div>dotnet</mat-chip><mat-chip _ngcontent-sxe-c26="" role="option" color="primary" class="mat-chip mat-focus-indicator keywords mat-primary mat-standard-chip" tabindex="-1" aria-disabled="false"><div class="mat-chip-ripple"></div>mediatr</mat-chip><mat-chip _ngcontent-sxe-c26="" role="option" color="primary" class="mat-chip mat-focus-indicator keywords mat-primary mat-standard-chip" tabindex="-1" aria-disabled="false"><div class="mat-chip-ripple"></div>CancellationToken</mat-chip><!---->
        </div></mat-chip-list>
        <h1 _ngcontent-sxe-c26="" class="blog-title">How to implement CQRS with MediatR - Part 2</h1>
        <div _ngcontent-sxe-c26="" class="sub-items-container">
            <time _ngcontent-sxe-c26="">Feb 27, 2021</time>
        </div>
    </div>
    <hr _ngcontent-sxe-c26="">
    <!--scullyContent-begin--><p _ngcontent-sxe-c26="">In this post we'll be using MediatR with a dotnet WebAPI. If you want to read about its implementation in a console application, check out my other blog <a href="https://krishnamohan.dev/blog/how-to-implement-cqrs-with-mediat-r---part-1" _ngcontent-sxe-c26="">post</a>.</p>
<p _ngcontent-sxe-c26="">For basic cases you can implement the message types and handlers mentioned in the Part 1. Here we are trying a different use case. The use of <code _ngcontent-sxe-c26="">CancellationToken</code> in <code _ngcontent-sxe-c26="">MediatR</code> to drop the ongoing request processing. This is very helpful if the request processing is blocked and we want to implement a timeout or if the request is dropped by the initiator.</p>
<p _ngcontent-sxe-c26="">For the sample case we will create a web api that try to do a task within 5 seconds. The API method will accept time in milliseconds and if the given time is greater than 5 seconds the task will run for 5 seconds and then get cancelled, otherwise task will be executed for the given time.</p>
<h2 id="prerequisites" _ngcontent-sxe-c26="">Prerequisites</h2>
<ul _ngcontent-sxe-c26="">
<li _ngcontent-sxe-c26="">Install <a href="https://dotnet.microsoft.com/download" _ngcontent-sxe-c26="">dotnet core</a></li>
<li _ngcontent-sxe-c26="">Install Visual Studio Code/Visual Studio IDE </li>
</ul>
<h2 id="creating-a-dotnet-webapi-application" _ngcontent-sxe-c26="">Creating a dotnet WebAPI application</h2>
<p _ngcontent-sxe-c26="">Run the following CLI command to create a WebAPI project.</p>
<pre _ngcontent-sxe-c26=""><code class="language-bash" _ngcontent-sxe-c26="">    dotnet new webapi MediatRSampleAPI
</code></pre>
<h2 id="configure-serilog-for-logging-optional" _ngcontent-sxe-c26="">Configure Serilog for logging (Optional)</h2>
<p _ngcontent-sxe-c26="">I'll be using <a href="https://serilog.net/" _ngcontent-sxe-c26="">Serilog</a> and a flat file sink for logging. To configure this we need to install the following dependencies via Nuget. </p>
<ul _ngcontent-sxe-c26="">
<li _ngcontent-sxe-c26="">Microsoft.Extensions.Logging</li>
<li _ngcontent-sxe-c26="">Serilog</li>
<li _ngcontent-sxe-c26="">Serilog.AspNetCore</li>
<li _ngcontent-sxe-c26="">Serilog.Sinks.File</li>
</ul>
<p _ngcontent-sxe-c26="">Then update the <code _ngcontent-sxe-c26="">Program.cs</code> file.</p>
<pre _ngcontent-sxe-c26=""><code class="language-C#" _ngcontent-sxe-c26="">    public static void Main(string[] args)
    {
        Log.Logger = new LoggerConfiguration()
                        .Enrich.FromLogContext()
                        .WriteTo.File("logs/MediatRSample.txt", rollingInterval: RollingInterval.Day)
                        .CreateLogger();
        try
        {
            Log.Information("Starting up");
            CreateHostBuilder(args).Build().Run();
        }
        catch (Exception ex)
        {
            Log.Fatal(ex, "Application start-up failed");
        }
        finally
        {
            Log.CloseAndFlush();
        }
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
        Host.CreateDefaultBuilder(args)
            .UseSerilog()
            .ConfigureWebHostDefaults(webBuilder =&gt;
            {
                webBuilder.UseStartup&lt;Startup&gt;();
            });
</code></pre>
<h2 id="install-and-configure-mediatr" _ngcontent-sxe-c26="">Install and Configure MediatR</h2>
<p _ngcontent-sxe-c26="">Next we need to install MediatR (version 9.0.0 at the time of writing) via Nuget. To configure MediatR, add the following snippet to the <code _ngcontent-sxe-c26="">ConfigureServices()</code> method in <code _ngcontent-sxe-c26="">Startup.cs</code> file.</p>
<pre _ngcontent-sxe-c26=""><code class="language-C#" _ngcontent-sxe-c26="">    services.AddMediatR(typeof(Startup));
</code></pre>
<h2 id="create-a-notification-message-and-its-handler" _ngcontent-sxe-c26="">Create a Notification message and its handler</h2>
<p _ngcontent-sxe-c26="">Our notification message carries time in milliseconds. Handler just accepts the time given by the user and waits for that much time. In the meantime if the request is cancelled, waiting will be stopped and exit.</p>
<p _ngcontent-sxe-c26="">I've added <code _ngcontent-sxe-c26="">Stopwatch</code> code to make sure that handler will wait for maximum 5 seconds. When cancellation is triggered and <code _ngcontent-sxe-c26="">OperationCanceledException</code> is thrown we need to catch it explicitly.</p>
<pre _ngcontent-sxe-c26=""><code class="language-C#" _ngcontent-sxe-c26="">    public class DelayNotificationMessage: INotification
    {
        public int TimeInMilliSeconds { get; set; }
    }

    public class Notifier03 : INotificationHandler&lt;DelayNotificationMessage&gt;
    {
        private readonly ILogger&lt;Notifier03&gt; _logger;
        public Notifier03(ILogger&lt;Notifier03&gt; logger)
        {
            _logger = logger;
        }
        public async Task Handle(DelayNotificationMessage notification, CancellationToken cancellationToken)
        {
            _logger.LogInformation($"Notifier 03 -&gt; Time In MIlli Seconds: {notification.TimeInMilliSeconds}");
            Stopwatch stopwatch = Stopwatch.StartNew();
            try
            {
                await Task.Delay(notification.TimeInMilliSeconds, cancellationToken);
            }
            catch(OperationCanceledException ex)
            {
                _logger.LogError("5 seconds passed and the task is cancelled");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex.Message);                
            }
            stopwatch.Stop();
            _logger.LogInformation($"Elapsed Time: {stopwatch.ElapsedMilliseconds}");            
        }
    }
</code></pre>
<h2 id="create-a-mediator-service" _ngcontent-sxe-c26="">Create a mediator service</h2>
<p _ngcontent-sxe-c26="">Mediator Service is a class that is used by the initiator to publish messages to the handlers. Here we'll the add the following code in the service class where <code _ngcontent-sxe-c26="">CancellationToken</code> is an optional parameter.</p>
<pre _ngcontent-sxe-c26=""><code class="language-C#" _ngcontent-sxe-c26="">    public void DelayedNotify(int timeInMilliSeconds, CancellationToken cancellationToken = default)
    {
        _mediator.Publish(new DelayNotificationMessage { TimeInMilliSeconds = timeInMilliSeconds }, cancellationToken);
        
</code></pre>
<h2 id="add-new-method-in-api-controller" _ngcontent-sxe-c26="">Add new method in API Controller</h2>
<p _ngcontent-sxe-c26="">Now let's add a controller method that creates a cancellation token. CancellationToken is set to cancel after 5 seconds using the <code _ngcontent-sxe-c26="">CancelAfter</code> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource?view=net-5.0#methods" _ngcontent-sxe-c26="">method</a> of <code _ngcontent-sxe-c26="">CancellationTokenSource</code></p>
<pre _ngcontent-sxe-c26=""><code class="language-C#" _ngcontent-sxe-c26="">    [HttpGet("/dowithin5seconds")]
    public async Task&lt;string&gt; DoWithin5Seconds(int timeInMilliSeconds)
    {
        CancellationTokenSource source = new CancellationTokenSource();
        CancellationToken token = source.Token;
        source.CancelAfter(5000);
        _mediatorService.DelayedNotify(timeInMilliSeconds, token);
        var message = "Finished within 5 seconds.";

        _logger.LogInformation(message);

        return message;
    }
</code></pre>
<h2 id="run-the-application" _ngcontent-sxe-c26="">Run the application</h2>
<p _ngcontent-sxe-c26="">To run the project via dotnet cli, run the following command.</p>
<pre _ngcontent-sxe-c26=""><code class="language-bash" _ngcontent-sxe-c26="">    dotnet run --project &lt;Path to *.csproj file&gt;
</code></pre>
<p _ngcontent-sxe-c26="">Once the port is open, invoke the <code _ngcontent-sxe-c26="">DoWithin5Seconds</code> method by entering '<a href="http://localhost:62705/dowithin5seconds?timeInMilliSeconds=15000'" _ngcontent-sxe-c26="">http://localhost:62705/dowithin5seconds?timeInMilliSeconds=15000'</a> in the browser (Your port number may vary. Also for the demo purpose it is better to disable https redirection).</p>
<p _ngcontent-sxe-c26="">You'll get the response immediately, but the process will run for a maximum of 5 seconds. If you check the log file, you can see that the execution stopped at 5 seconds.</p>
<pre _ngcontent-sxe-c26=""><code class="language-bash" _ngcontent-sxe-c26="">2021-02-27 12:46:57.384 +05:30 [INF] Executing endpoint 'MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds (MediatRSampleAPI)'
2021-02-27 12:46:57.425 +05:30 [INF] Route matched with {action = "DoWithin5Seconds", controller = "SlowTest"}. Executing controller action with signature System.Threading.Tasks.Task`1[System.String] DoWithin5Seconds(Int32) on controller MediatRSampleAPI.Controllers.SlowTestController (MediatRSampleAPI).
2021-02-27 12:46:57.517 +05:30 [INF] Executing action method MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds (MediatRSampleAPI) - Validation state: "Valid"
2021-02-27 12:46:57.524 +05:30 [INF] Notifier 03 -&gt; Time In MIlli Seconds: 15000
2021-02-27 12:46:57.526 +05:30 [INF] Finished within 5 seconds.
2021-02-27 12:47:02.576 +05:30 [ERR] 5 seconds passed and the task is cancelled
2021-02-27 12:47:02.577 +05:30 [INF] Elapsed Time: 5052
</code></pre>
<p _ngcontent-sxe-c26="">Full source code is available in <a href="https://github.com/krishnaanaril/try-outs/tree/master/MediatRSample/MediatRSampleAPI" _ngcontent-sxe-c26="">GitHub</a>.</p>
<h2 id="final-thoughts" _ngcontent-sxe-c26="">Final Thoughts</h2>
<p _ngcontent-sxe-c26="">If you are more interested in the use of <code _ngcontent-sxe-c26="">CancellationToken</code>, please checkout the <a href="https://andrewlock.net/using-cancellationtokens-in-asp-net-core-mvc-controllers/" _ngcontent-sxe-c26="">post</a> by Andrew Lock.</p>
<p _ngcontent-sxe-c26="">One thing I haven't explored so far is exception handling with MediatR. It requires a blog post of its own and I'll be posting it soon.</p>
<!--scullyContent-end--><scully-content _ngcontent-sxe-c26=""></scully-content>
    <hr _ngcontent-sxe-c26="">
    <div _ngcontent-sxe-c26="" class="post-footer">
        Have questions/comments? Tweet @<a _ngcontent-sxe-c26="" href="https://twitter.com/krishnaanaril">krishnaanaril</a>
    </div>
<script>try {window['scullyContent'] = {cssId:"_ngcontent-sxe-c26",html:document.body.innerHTML.split('<!--scullyContent-begin-->')[1].split('<!--scullyContent-end-->')[0]};} catch(e) {console.error('scully could not parse content');}</script></div><!----></app-blog><!----></app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
<script id="ScullyIO-transfer-state"></script><script src="runtime-es2015.c522a9070bf33bce67b5.js" type="module"></script><script src="runtime-es5.c522a9070bf33bce67b5.js" nomodule="" defer=""></script><script src="polyfills-es5.29147128fc6f0f3fd286.js" nomodule="" defer=""></script><script src="polyfills-es2015.2045db6d95f407e1e8c7.js" type="module"></script><script src="main-es2015.caa4d0242215b095a5dc.js" type="module"></script><script src="main-es5.caa4d0242215b095a5dc.js" nomodule="" defer=""></script>

</body></html>